# 企业级邮件订单自动化系统

基于AI Agent的企业邮件订单自动化处理系统，支持多格式订单识别、数据标准化、数据库集成和Web管理界面。

## 系统概述

本系统旨在自动化处理工厂运营中的订单邮件，通过AI识别技术从不同格式的Excel和图片中提取订单信息，实现订单数据的标准化和自动录入，大幅提升运营效率。

### 核心功能

1. **实时邮件监听服务**
   - 自动连接企业邮箱（IMAP协议）
   - 每30秒轮询新订单邮件
   - 自动提取附件（Excel和图片）并归档

2. **AI多格式识别引擎**
   - 使用LLM识别Excel表格内容
   - 使用Vision API识别图片中的订单信息
   - 支持不同客户的多种订单格式
   - 提取标准字段：产品编码、数量、规格、交期、客户信息

3. **智能数据标准化**
   - 灵活的字段映射配置
   - 自动数据清洗和验证
   - 异常检测和置信度评估
   - 支持自定义验证规则

4. **MySQL数据库集成**
   - 自动将标准化订单写入数据库
   - 订单状态管理（待处理、已确认、处理中、已完成、异常）
   - 完整的处理日志追踪
   - 支持订单项目详细记录

5. **实时Web管理界面**
   - 仪表板展示实时统计数据
   - 订单列表支持分页、过滤、排序
   - 异常订单审核和手动调整
   - 处理日志查询和问题排查
   - 邮箱配置管理

6. **异常检测与人工审核**
   - AI识别置信度低于阈值自动标记
   - 数据异常自动检测
   - 运营人员可查看原始数据
   - 支持手动修改和确认

7. **处理日志追踪**
   - 记录每封邮件的处理状态
   - 保存AI识别结果
   - 错误信息记录
   - 支持历史查询和问题排查

## 技术架构

### 技术栈

| 组件 | 技术 |
|------|------|
| 前端框架 | React 19 + TypeScript + TailwindCSS 4 |
| 后端框架 | Express 4 + tRPC 11 |
| 数据库 | MySQL 8.0+ |
| ORM | Drizzle ORM |
| AI能力 | OpenAI Vision API + LLM |
| 认证 | Manus OAuth |
| UI组件 | shadcn/ui + Radix UI |

### 数据库设计

#### 订单表（orders）
- 订单基本信息（订单号、客户名称、邮箱）
- 订单日期和交期
- 订单状态（pending/confirmed/processing/completed/exception）
- AI识别置信度
- 来源邮件ID和备注

#### 订单项目表（orderItems）
- 产品编码
- 数量和规格
- 单价和总价
- 关联订单ID

#### 处理日志表（processingLog）
- 邮件信息（ID、主题、发件人）
- 附件信息（名称、类型）
- 处理状态和错误信息
- AI识别结果（JSON格式）

#### 邮箱配置表（emailConfig）
- IMAP连接配置
- 字段映射规则（JSON格式）
- 激活状态和最后同步时间

## 快速开始

### 1. 生成模拟数据

首次使用时，点击仪表板页面的"生成模拟数据"按钮，系统会自动创建：
- 5个示例订单（包含不同状态）
- 6条处理日志（包含成功和失败案例）
- 1个默认邮箱配置

### 2. 查看订单列表

导航到"订单管理"页面，可以：
- 查看所有订单
- 按状态筛选订单
- 查看AI识别置信度
- 点击"查看"按钮查看订单详情

### 3. 审核异常订单

在订单详情页面，对于状态为"待处理"或"异常"的订单：
- 查看完整订单信息和项目
- 查看AI识别置信度
- 添加备注信息
- 点击"确认订单"或"拒绝订单"

### 4. 查看处理日志

导航到"处理日志"页面，可以：
- 查看所有邮件处理记录
- 查看处理状态和时间
- 点击"详情"查看AI识别结果
- 查看错误信息（如果处理失败）

### 5. 配置邮箱（生产环境）

在生产环境中使用时：
1. 导航到"邮箱配置"页面
2. 配置IMAP连接信息：
   - IMAP服务器地址
   - 端口（通常为993）
   - 用户名和密码
   - 是否使用SSL
3. 配置字段映射规则（JSON格式）
4. 激活配置
5. 点击"启动监听"开始自动处理邮件

## API接口

### 订单管理

- `orders.list` - 获取订单列表（支持分页和状态筛选）
- `orders.getById` - 获取订单详情（包含订单项目）
- `orders.updateStatus` - 更新订单状态
- `orders.update` - 更新订单信息

### 处理日志

- `processingLog.list` - 获取处理日志列表

### 仪表板

- `dashboard.stats` - 获取统计数据（订单数、成功率等）

### 邮件服务

- `email.status` - 获取邮件监听服务状态
- `email.start` - 启动邮件监听服务
- `email.stop` - 停止邮件监听服务
- `email.sync` - 手动触发邮件同步
- `email.processAttachment` - 处理单个邮件附件

### 测试数据

- `seed.all` - 生成模拟数据（仅用于演示）

## AI识别流程

### Excel识别

1. 读取Excel文件内容
2. 将表格数据转换为文本格式
3. 使用LLM提取订单信息
4. 应用字段映射规则
5. 验证数据完整性
6. 评估识别置信度

### 图片识别

1. 上传图片到存储服务
2. 使用Vision API识别图片中的文本
3. 使用LLM提取订单信息
4. 应用字段映射规则
5. 验证数据完整性
6. 评估识别置信度

### 置信度评估

- **高置信度（≥80%）**：自动确认，直接进入处理流程
- **中等置信度（60-79%）**：标记为"待处理"，需要人工审核
- **低置信度（<60%）**：标记为"异常"，必须人工审核

## 字段映射配置

字段映射规则使用JSON格式，支持多个别名：

```json
{
  "productCode": ["产品编码", "Product Code", "SKU", "货号"],
  "quantity": ["数量", "Qty", "Quantity", "订购数量"],
  "specification": ["规格", "Spec", "Specification", "型号"],
  "deliveryDate": ["交期", "Delivery Date", "Due Date", "交货日期"],
  "customerName": ["客户", "Customer", "客户名称", "公司名称"]
}
```

AI识别时会尝试匹配这些别名，提高识别准确率。

## 异常处理机制

### 异常类型

1. **识别异常**：AI识别置信度低于阈值
2. **数据异常**：必填字段缺失或数据格式错误
3. **验证异常**：订单数据不符合业务规则
4. **系统异常**：邮件连接失败、数据库写入失败等

### 处理流程

1. 异常订单自动进入"待审核"状态
2. 管理界面高亮显示异常订单
3. 运营人员查看原始数据和AI识别结果
4. 支持手动修改和确认
5. 确认后自动写入数据库

## 安全性设计

- **邮箱凭证**：使用环境变量存储，不硬编码
- **数据库连接**：使用连接池，支持SSL加密
- **API认证**：使用Manus OAuth认证
- **日志记录**：所有操作都有审计日志
- **数据隐私**：敏感信息加密存储

## 性能优化

- **异步处理**：使用tRPC异步特性处理高并发
- **批量操作**：批量写入数据库，减少I/O
- **数据库索引**：为常用查询字段建立索引
- **缓存机制**：缓存客户配置和字段映射

## 注意事项

### 生产环境部署

1. **邮箱配置**：确保IMAP凭证正确，测试连接
2. **数据库配置**：使用生产数据库连接字符串
3. **AI API密钥**：配置OpenAI API密钥（系统已内置）
4. **监控告警**：设置邮件监听状态监控
5. **数据备份**：定期备份订单数据

### 限制说明

1. **邮件监听**：当前使用模拟实现，生产环境需配置真实IMAP连接
2. **附件大小**：建议单个附件不超过10MB
3. **并发处理**：建议每批处理不超过10封邮件
4. **AI识别**：识别准确率取决于订单格式的规范程度

### 最佳实践

1. **字段映射**：为每个客户配置专门的字段映射规则
2. **定期审核**：定期审核异常订单，优化识别规则
3. **数据验证**：设置合理的数据验证规则
4. **日志监控**：定期查看处理日志，发现潜在问题
5. **备份策略**：建立完善的数据备份和恢复机制

## 开发命令

```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm dev

# 推送数据库变更
pnpm db:push

# 运行测试
pnpm test

# 构建生产版本
pnpm build

# 启动生产服务器
pnpm start
```

## 系统架构图

```
邮件服务器 (IMAP)
       ↓
邮件监听服务 (30秒轮询)
       ↓
附件提取 (Excel/图片)
       ↓
AI识别引擎 (LLM + Vision)
       ↓
数据标准化 (字段映射 + 验证)
       ↓
    ┌─────┴─────┐
正常订单    异常订单
    ↓           ↓
数据库     人工审核
    ↓           ↓
Web管理界面 ←────┘
```

## 支持与反馈

如有问题或建议，请通过以下方式联系：
- 系统管理员
- 技术支持团队
- 项目文档：参考本README和系统架构设计文档

---

**版本**: 1.0.0  
**最后更新**: 2024年1月
